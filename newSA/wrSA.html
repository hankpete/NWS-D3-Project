<!DOCTYPE html>
<html lang="en">

	<head>		
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<meta http-equiv="refresh" content="3600">
		<title>wrSA</title>
		<script type="text/javascript" src="d3/d3.v3.js"></script>
		<script type="text/javascript" src="d3/topojson.v1.min.js"></script>
		<script type="text/javascript" src="d3/togeojson.js"></script>
		<style type="text/css">

rect {
  fill: none;
  pointer-events: all;
}

			body
			{	
				height: 100%;
				width: 100%;
				margin: 0;
				float: left;
				background-color:white;
				overflow:hidden;
			}

			div#map
			{
				position:absolute;
				top:0%;
				left:5%;
				height:100%;
				width:100%;
				fill:green;
 				fill-opacity:70%;
				stroke-width: .5px;
				stroke:gray;
				stroke-opacity:50%;
				z-index:-100;
				pointer-events: all;
			}

			.feature {
				fill: #ccc;
				cursor: pointer;
			}

			.feature.active {
				fill: gray;
			}

			.mesh {
				fill: none;
				stroke: #fff;
				stroke-linejoin: round;
			}


			div#info
			{
				position:absolute;
				top:5%;
				left:55%;
				height:100%;
				width:45%;
				fill:white;
 				fill-opacity:10%;
				stroke:black;
				stroke-opacity:100%;
				z-index:-1000;			
			}

			.infoText
			{
				stroke:black;
				stroke-width:1;
				fill:black;
				fill-opacity:100%;
				font-size:200%;
			}

			.mappedStationMarker
			{
							
			}

			.mappedStationText
			{
				stroke:black;
				stroke-width:1;
				fill:black;
				fill-opacity:100%;
				font-size:90%;
			}


			.currentMappedStation
			{					
				fill:yellow;
				fill-opacity:50%;
				stroke:yellow;
				stroke-width:2;
			}

			.currentMappedStationText
			{	
				stroke:black;
				stroke-width:0;
				fill:black;
				fill-opacity:100%;
				font-size:105%;
			}
			.currentFire
			{					
				fill:red;
				fill-opacity:70%;
				stroke:yellow;
				stroke-width:2;
			}

			.currentFireText
			{	
				stroke:black;
				stroke-width:0;
				fill:black;
				fill-opacity:100%;
				font-size:105%;
			}	
		</style>

	</head>

<body> 

<div id="map"></div>
<div id="info"></div>

    <script type="text/javascript">

	//start global variables
	var width = screen.width
	var height = screen.height
	var active

	var JsonToMap
	var b,s,t;
	var projection = d3.geo.mercator().scale(1).translate([0, 0])
	var path = d3.geo.path().projection(projection)	
	var scaleFactor = .7 //1=100% .5=50%, etc.
	var zoomTime = 1000


	var map = d3.select("#map").append("svg")	
		.attr("width", "100%")
		.attr("height", "100%")

	map.append("rect")
		.attr("width", width)
		.attr("height", height)
		.on("click", reset);

	var g = map.append("g")	

	var info = d3.select("#info").append("svg")	
		.attr("width", "100%")
		.attr("height", "100%")

	var fireRss = "ba-simple-proxy/ba-simple-proxy.php?&url=http://inciweb.org/feeds/rss/incidents/state/5&mode=native"
	var fireJson

	var obsUrl = "ba-simple-proxy/ba-simple-proxy.php?&url=http://www.wrh.noaa.gov/hnx/JimBGmwXJList.php?extents=34.74,-121.3,38.5,-117.62&mode=native"
	var jsonObs

	var dwellTime=10000


	var color = d3.scale.threshold()
			.domain([32, 50, 60, 70])
			.range(["white","blue","green","yellow","red"]);


/*
//from http://bl.ocks.org/mbostock/3795040
var λ = d3.scale.linear()
    .domain([0, width])
    .range([-180, 180]);

var φ = d3.scale.linear()
    .domain([0, height])
    .range([90, -90]);

map.on("mousemove", function() {
  var p = d3.mouse(this);
  projection.rotate([λ(p[0]), φ(p[1])]);
  map.selectAll("path").attr("d", path);
});
*/

//  from http://bl.ocks.org/mbostock/6242308




	//end global variables

	//start functions

	function xmlToJson(xml) 
	{
    		var attr,
	        child,
	        attrs = xml.attributes,
		children = xml.childNodes,
		key = xml.nodeType,
		obj = {},
		i = -1;

		if (key == 1 && attrs.length) 
		{
			obj[key = '@attributes'] = {};
      			while (attr = attrs.item(++i)) 
			{
			        obj[key][attr.nodeName] = attr.nodeValue;
			}
			i = -1;
		} else if (key == 3) 
		{
			obj = xml.nodeValue;
		}
		while (child = children.item(++i)) 
		{
	      		key = child.nodeName;
			if (obj.hasOwnProperty(key)) 
			{
			        if (obj.toString.call(obj[key]) != '[object Array]') 
				{
          				obj[key] = [obj[key]];
			        }
			        obj[key].push(xmlToJson(child));
			}
			else 
			{
        			obj[key] = xmlToJson(child);
			}
		}
		return obj;
	}


function loadCwaMap()
{
	//project to bounding box http://bl.ocks.org/mbostock/4707858
	//zoom to bounding box http://bl.ocks.org/mbostock/4699541
	d3.json("CWAs.json", function(error, us) 
	{
		                  //.mesh/feature
		JsonToMap = topojson.mesh(us, us.objects.cwas)


		getBST(JsonToMap)
		projection.scale(s).translate(t);

		g.selectAll("path")
			.data(topojson.feature(us, us.objects.cwas).features)
			.enter().append("path")
			.attr("d", path)
			.attr("class", "feature")
			.on("click", click);
	}
	);
}

function getBST(JsonToMap) //Boundingbox, Scale, Transform
{
console.log("d: ",JsonToMap)
b = path.bounds(JsonToMap)      							    //compute bounding box b of JsonToMap (d) 
s = scaleFactor / Math.max( (b[1][0] - b[0][0]) / (width), (b[1][1] - b[0][1]) / (height) )   //calculate scale based on ratio of bounding box to screen dimensions
t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2] //translate to center of bounding box
console.log("b:"+b+" s:"+s+" t:"+t)
}


function click(d)
{
	console.log("clicked!  active:",active);
	getBST(d)
	
	if (active === d) return reset();
	g.selectAll(".active").classed("active", false);
	d3.select(this).classed("active", active = d);
	

	g.transition()
		.duration(zoomTime)
		.attr("transform","translate(" + t + ")"+ "scale(" + s + ")" )
}

function reset() 
{
	console.log("reset:");
	g.selectAll(".active").classed("active", active = false);
	g.transition().duration(zoomTime).attr("transform", "");
}


	function getFireRss()
	{
		d3.xml(fireRss, function(error, d)
					{	
					if (error) return console.log("there was an error loading the data: " + error)	
						fireJson=xmlToJson(d)
						//console.log("fireJson: ",fireJson)
						//console.log("fireJson: "+JSON.stringify(fireJson));		
						mapStationMarkers(fireJson)
						mapStationText(fireJson)
/*
						for (var k=0;  k<jsonObs.stations.length; ++k)
						{											
							j=jsonObs.stations[k] //append a NDFD forecast for every station in jsonObs to jsonObs
							var lat=j.latitude.trim()
							var lon=j.longitude.trim()
							var fcstUrl = "http://forecast.weather.gov/MapClick.php?lat="+lat+"&lon="+lon+"&FcstType=json"
							fetch(fcstUrl,k)
						}
*/
					}
		);			
		
	}


	function getData()
	{
		d3.json(obsUrl, function(error, d)
					{	
					if (error) return console.log("there was an error loading the data: " + error)	
						jsonObs=d									
						//console.log("jsonObs: "+JSON.stringify(jsonObs));
						mapStationMarkers(jsonObs)
						//mapStationText(jsonObs)
						getFcsts(jsonObs)
						
					}
		);	
	}


	function getFcsts()
	{
		for (var k=0;  k<jsonObs.stations.length; ++k)
						{											
							j=jsonObs.stations[k] //append a NDFD forecast for every station in jsonObs to jsonObs
							var lat=j.latitude//.trim()
							var lon=j.longitude//.trim()							
							//var fcstUrl = "http://forecast.weather.gov/MapClick.php?lat="+lat+"&lon="+lon+"&FcstType=json"
							var furl= "http%3A%2F%2Fforecast.weather.gov%2FMapClick.php%3Flat%3D"+lat+"%26lon%3D"+lon+"%26FcstType%3Djson&mode=native"
							var fcstUrl = "ba-simple-proxy/ba-simple-proxy.php?/&url="+furl
							fetch(fcstUrl,k)
						}
	}

		function fetch(fcstUrl,k)
		{
			d3.json(fcstUrl, function(d)
						{jsonObs.stations[k].forecast=d;//console.log(jsonObs.stations[k]);
						}
						);
		}



	function mapStationMarkers(d)	
	{		
		g.selectAll(".mappedStationMarker").remove();
	        g.selectAll("mappedStationMarker").data(d.stations).enter()	     
				.append("circle")
					.attr("class","mappedStationMarker")
					.attr("cx", function(d) { return projection([d.longitude, d.latitude])[0]; })
					.attr("cy", function(d) { return projection([d.longitude, d.latitude])[1]; })
		                	.attr("r", "1")
					.attr("stroke","1")
					.attr("fill", function(d) {return color(d.Temp)})
					.attr("fill-opacity", "100%")
	}
	
	function mapStationText(d)
	{
		map.selectAll(".mappedStationText").remove();		
		map.selectAll("mappedStationText").data(d.stations).enter()
				.append("text")
					.attr("class", "mappedStationText")
					.attr("x", function(d) { return 7+projection([d.longitude, d.latitude])[0]; })
					.attr("y", function(d) { return projection([d.longitude, d.latitude])[1]; })
					.text(function(d){return d.Temp})
	}

	function mapFireText(fj,l)
	{
		d=fj.rss.channel.item[l]
		lat=d['geo:lat']['#text']
		lon=d['geo:long']['#text']
		title=d['title']['#text']
		desc=d['description']['#text']

//console.log("d: ",title)

		g.select(".currentFire").remove();
		info.select(".currentFireText").remove();
		info.select(".infoText").remove();

		//map.selectAll("mappedStationText").data(d.rss.channel.item).enter()
		g.append("circle")
				.attr("class", "currentFire")
				.attr("cx", function(d) { return projection( [lon,lat])[0] })
				.attr("cy", function(d) { return projection( [lon,lat])[1] })
				.attr("r","10")
	
		info.append("text")
				.attr("class", "currentFireText")
				.attr("x","5%" )
				.attr("y","5%" )
				.text(title)

		info.append("foreignObject")
				.attr("class", "infoText")
				.attr("x", "5%")
				.attr("y","10%")
				.attr("width", "90%")
				.attr("height", "90%")
				.text(desc)


/*
		var jim = info.select(".infoText")
		jim		
			.transition().duration(dwellTime*.7)
				.attr("transform","translate(0,1500)")
			.transition().delay(dwellTime*.3)
*/
	}

//end functions

//main
loadCwaMap()
//getFireRss()

getData()

// every hour regrab obs and forecasts
	setInterval(function()
		{
			loadCwaMap()
			//getFireRss()
			getData()
		}, 3600000
	);


// every 5 seconds display a new station from fireJson with along forecast info
	var l=0 

/*setInterval(function()
			{
				if (l == (jsonObs.station.length-1)){l=0;} else {l=l+1;}
				mapStationText(jsonObs,l);
			}, dwellTime
	);
*/
setInterval(function()
			{
				//if (l == (fireJson.rss.channel.item.length-1)){l=0;} else {l=l+1;}
				//mapFireText(fireJson,l);
/*
				if (jsonObs.stations[l].id=="CQ086extended")
					{buildFcst(jsonObs.stations[l],4,8)}
				else if (jsonObs.stations[l].id=="CQ086")
					{
						//console.log("displaying valley once...")
						buildFcst(jsonObs.stations[l],0,4)
						//console.log("...then deleting from jsonObs")
						jsonObs.stations.splice(l,1)
					}
				else {buildFcst(jsonObs.stations[l],0,4)}
*/
			}, dwellTime
	);


    </script>
    </body>
</html>
